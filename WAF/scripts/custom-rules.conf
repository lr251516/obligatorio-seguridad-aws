# ModSecurity Custom Rules para Fósil Energías Renovables
# /opt/coreruleset/rules/REQUEST-900-CUSTOM-RULES.conf

# REGLA PERSONALIZADA 1: Bloquear acceso a endpoints administrativos desde IPs no autorizadas
# Solo permitir acceso a /admin desde red interna AWS (10.0.1.0/24)
SecRule REQUEST_URI "@beginsWith /admin" \
    "id:900001,\
    phase:1,\
    block,\
    t:none,\
    msg:'Acceso no autorizado a endpoint administrativo',\
    logdata:'IP: %{REMOTE_ADDR} - URI: %{REQUEST_URI}',\
    severity:CRITICAL,\
    chain"
    SecRule REMOTE_ADDR "!@ipMatch 10.0.1.0/24" \
        "t:none,\
        setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# REGLA PERSONALIZADA 2: Detectar y bloquear intentos de escaneo de directorios
# Bloquear patrones típicos de herramientas de escaneo (nikto, dirb, dirbuster, etc.)
SecRule REQUEST_URI "@rx (?i)(?:\.\.\/|\.\.\\|etc\/passwd|boot\.ini|windows\/system)" \
    "id:900002,\
    phase:1,\
    block,\
    t:none,t:urlDecodeUni,\
    msg:'Intento de Path Traversal detectado',\
    logdata:'IP: %{REMOTE_ADDR} - URI: %{REQUEST_URI} - User-Agent: %{REQUEST_HEADERS.User-Agent}',\
    severity:CRITICAL,\
    tag:'attack-lfi',\
    tag:'OWASP_TOP_10',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# REGLA PERSONALIZADA 3: Rate limiting agresivo para APIs de telemetría
# Limitar requests a endpoints /api/telemetry a 20 req/min por IP
SecAction "id:900003,\
    phase:1,\
    nolog,\
    pass,\
    initcol:ip=%{REMOTE_ADDR},\
    setvar:ip.telemetry_counter=0,\
    expirevar:ip.telemetry_counter=60"

SecRule REQUEST_URI "@beginsWith /api/telemetry" \
    "id:900004,\
    phase:2,\
    block,\
    t:none,\
    msg:'Rate limit excedido en API de telemetría',\
    logdata:'IP: %{REMOTE_ADDR} - Requests: %{ip.telemetry_counter}',\
    severity:WARNING,\
    chain"
    SecRule IP:TELEMETRY_COUNTER "@gt 20" \
        "t:none,\
        setvar:ip.telemetry_counter=+1,\
        setvar:'tx.anomaly_score_pl2=+%{tx.warning_anomaly_score}'"

SecRule REQUEST_URI "@beginsWith /api/telemetry" \
    "id:900005,\
    phase:2,\
    pass,\
    nolog,\
    t:none,\
    setvar:ip.telemetry_counter=+1"

# REGLA PERSONALIZADA 4: Detectar credenciales expuestas en URLs
# Bloquear requests con posibles credenciales en query strings
SecRule ARGS_NAMES "@rx (?i)(?:password|passwd|pwd|api_key|apikey|token|secret|auth)" \
    "id:900006,\
    phase:2,\
    block,\
    t:none,\
    msg:'Posible credencial expuesta en URL',\
    logdata:'IP: %{REMOTE_ADDR} - Param: %{MATCHED_VAR_NAME}',\
    severity:ERROR,\
    tag:'security-misconfiguration',\
    setvar:'tx.anomaly_score_pl2=+%{tx.error_anomaly_score}'"

# REGLA PERSONALIZADA 5: Bloquear User-Agents conocidos de bots maliciosos
SecRule REQUEST_HEADERS:User-Agent "@rx (?i)(?:nikto|sqlmap|nmap|masscan|metasploit|havij|acunetix)" \
    "id:900007,\
    phase:1,\
    block,\
    t:none,t:lowercase,\
    msg:'User-Agent de herramienta de escaneo detectado',\
    logdata:'IP: %{REMOTE_ADDR} - User-Agent: %{REQUEST_HEADERS.User-Agent}',\
    severity:CRITICAL,\
    tag:'security-scanner',\
    setvar:'tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}'"

# REGLA PERSONALIZADA 6: Protección específica para endpoints de energía renovable
# Validar formato de datos JSON en POST a /api/solar y /api/wind
SecRule REQUEST_URI "@rx ^/api/(?:solar|wind)" \
    "id:900008,\
    phase:2,\
    block,\
    t:none,\
    msg:'Formato JSON inválido en API de energía',\
    logdata:'IP: %{REMOTE_ADDR} - Content-Type: %{REQUEST_HEADERS.Content-Type}',\
    severity:WARNING,\
    chain"
    SecRule REQUEST_METHOD "@streq POST" \
        "chain"
        SecRule REQUEST_HEADERS:Content-Type "!@contains application/json" \
            "t:none,t:lowercase,\
            setvar:'tx.anomaly_score_pl2=+%{tx.warning_anomaly_score}'"

# Configuración de respuesta personalizada para bloqueos
SecRule TX:ANOMALY_SCORE "@ge %{tx.inbound_anomaly_score_threshold}" \
    "id:900999,\
    phase:5,\
    deny,\
    status:403,\
    t:none,\
    msg:'Solicitud bloqueada por WAF de Fósil Energías',\
    logdata:'Anomaly Score: %{TX.ANOMALY_SCORE} - IP: %{REMOTE_ADDR}',\
    tag:'FOSIL-WAF'"