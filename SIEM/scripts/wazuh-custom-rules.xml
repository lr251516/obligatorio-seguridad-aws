<!-- /var/ossec/etc/rules/local_rules.xml -->
<!-- Reglas personalizadas - Fósil Energías Renovables -->
<!-- Estas reglas funcionan con Wazuh 4.13.1 -->

<group name="local,authentication,">

  <!-- CASO 1: Múltiples intentos de autenticación fallidos (SSH) -->
  <rule id="100001" level="10" frequency="5" timeframe="300">
    <if_matched_sid>5503</if_matched_sid>
    <description>Wazuh: Múltiples intentos de autenticación SSH fallidos</description>
    <mitre>
      <id>T1110</id>
    </mitre>
    <group>authentication_failures,</group>
  </rule>

  <!-- Alerta crítica desde IP externa -->
  <rule id="100002" level="12">
    <if_sid>100001</if_sid>
    <srcip>!10.0.1.0/24</srcip>
    <description>Wazuh: Brute force desde IP externa (fuera de VPC)</description>
    <mitre>
      <id>T1110</id>
    </mitre>
    <group>authentication_failures,attacks,</group>
  </rule>

  <!-- Alerta crítica en usuario privilegiado -->
  <rule id="100003" level="12">
    <if_sid>100001</if_sid>
    <user>root|admin|ubuntu</user>
    <description>Wazuh: Brute force en cuenta privilegiada</description>
    <mitre>
      <id>T1110</id>
    </mitre>
    <group>authentication_failures,privilege_escalation,</group>
  </rule>

</group>

<group name="local,syscheck,">

  <!-- CASO 3: File Integrity Monitoring -->

  <!-- Cambios en archivos de usuarios -->
  <rule id="100020" level="10">
    <if_sid>550</if_sid>
    <match>/etc/passwd|/etc/shadow|/etc/group</match>
    <description>Wazuh: Cambio en archivos de usuarios del sistema</description>
    <mitre>
      <id>T1098</id>
    </mitre>
    <group>syscheck,account_changed,</group>
  </rule>

  <!-- Cambios en sudoers (crítico) -->
  <rule id="100021" level="12">
    <if_sid>550</if_sid>
    <match>/etc/sudoers</match>
    <description>Wazuh: Cambio CRÍTICO en configuración sudo</description>
    <mitre>
      <id>T1548.003</id>
    </mitre>
    <group>syscheck,privilege_escalation,</group>
  </rule>

  <!-- Cambios en SSH -->
  <rule id="100022" level="10">
    <if_sid>550</if_sid>
    <match>/etc/ssh/sshd_config|authorized_keys</match>
    <description>Wazuh: Cambio en configuración SSH</description>
    <mitre>
      <id>T1098.004</id>
    </mitre>
    <group>syscheck,ssh,</group>
  </rule>

  <!-- Cambios en firewall -->
  <rule id="100023" level="10">
    <if_sid>550</if_sid>
    <match>/etc/ufw|/etc/iptables</match>
    <description>Wazuh: Cambio en configuración de firewall</description>
    <mitre>
      <id>T1562.004</id>
    </mitre>
    <group>syscheck,firewall,</group>
  </rule>

</group>
